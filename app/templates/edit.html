{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto mt-10 px-4">
    <div class="glass p-8 rounded-2xl border-2 border-blue-500/30">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Edit Entry #{{ entry.id }}</h2>
            <span class="bg-blue-600 text-xs font-bold px-3 py-1 rounded text-white animate-pulse">EDITING MODE</span>
        </div>

        <form action="/edit/{{ entry.id }}" method="POST" class="space-y-6">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Date</label>
                    <input type="date" name="date" value="{{ entry.date }}" required
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white [color-scheme:dark] outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Vendor</label>
                    <div class="relative">
                        <select name="vendor" id="vendorSelect" required onchange="autoCalc()"
                                class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white appearance-none outline-none focus:border-blue-500 cursor-pointer">
                            {% for v in vendors %}
                            <option value="{{ v.id }}"
                                    data-rate="{{ v.rate_per_parcel }}"
                                    data-trans="{{ v.transport_rate }}"
                                    data-flag-rail="{{ '1' if v.show_railway else '0' }}"
                                    data-flag-handle="{{ '1' if v.show_handling else '0' }}"
                                    data-flag-trans="{{ '1' if v.show_transport else '0' }}"
                                    {% if v.id == entry.vendor_id %}selected{% endif %}>
                                {{ v.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">RR No</label>
                    <input type="text" name="rr_no" value="{{ entry.rr_no or '' }}"
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">From</label>
                    <input type="text" name="from" value="{{ entry.ship_from or 'Mumbai' }}"
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">To</label>
                    <input type="text" name="to" value="{{ entry.ship_to or 'Udupi' }}"
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white outline-none focus:border-blue-500">
                </div>
            </div>

            <hr class="border-gray-700">

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">

                <div>
                    <label class="block text-xs uppercase text-blue-400 mb-1 font-bold">No. Parcels</label>
                    <input type="number" name="parcels" id="parcels" value="{{ entry.parcels }}" required oninput="autoCalc()"
                           class="w-full h-10 bg-blue-900/20 border border-blue-500/50 rounded px-3 text-white font-bold text-center outline-none focus:border-blue-500">
                </div>

                <div id="div_railway">
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Railway Fare</label>
                    <input type="number" step="0.1" name="railway" id="railway" value="{{ entry.railway_chg }}" oninput="updateTotalOnly()"
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white text-center outline-none focus:border-blue-500">
                </div>

                <div id="div_handling">
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Handling</label>
                    <input type="number" step="0.1" name="handling" id="handling" value="{{ entry.handling_chg }}" oninput="updateTotalOnly()"
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white text-center outline-none focus:border-blue-500">
                </div>

                <div id="div_transport">
                    <label class="block text-xs uppercase text-gray-500 mb-1 font-bold">Transport</label>
                    <input type="number" step="0.1" name="transport" id="transport" value="{{ entry.transport_chg }}" oninput="updateTotalOnly()"
                           class="w-full h-10 bg-black/40 border border-gray-700 rounded px-3 text-white text-center outline-none focus:border-blue-500">
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 items-end mt-4">
                <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded-lg w-full text-right flex justify-between items-center px-6">
                    <span class="text-xs text-blue-300 uppercase font-bold tracking-wider">Grand Total Bill Amount</span>
                    <span class="text-2xl font-bold text-white" id="display_total">₹{{ "{:,.0f}".format(entry.grand_total) }}</span>
                </div>
            </div>

            <div class="flex gap-4 mt-6 pt-4 border-t border-gray-700">
                <a href="/view" class="flex-1 text-center py-3 rounded border border-gray-600 text-gray-400 hover:bg-gray-800 font-bold text-sm">CANCEL</a>
                <button type="submit" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-500 shadow-lg text-sm uppercase tracking-wider">
                    Update Entry
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function getVal(id) {
        return parseFloat(document.getElementById(id).value) || 0;
    }

    function autoCalc() {
        const parcels = getVal('parcels');
        const vendorSelect = document.getElementById('vendorSelect');
        const selectedOption = vendorSelect.options[vendorSelect.selectedIndex];

        const ratePerParcel = parseFloat(selectedOption.getAttribute('data-rate')) || 0;
        const flatTransport = parseFloat(selectedOption.getAttribute('data-trans')) || 0;

        // Check Flags
        const showRail = selectedOption.getAttribute('data-flag-rail') === '1';
        const showHandle = selectedOption.getAttribute('data-flag-handle') === '1';
        const showTrans = selectedOption.getAttribute('data-flag-trans') === '1';

        toggleField('div_railway', 'railway', showRail);
        toggleField('div_handling', 'handling', showHandle);
        toggleField('div_transport', 'transport', showTrans);

        let handling = 0;
        let transport = 0;

        if (parcels > 0) {
            if(showHandle) handling = parcels * ratePerParcel;
            if(showTrans) transport = flatTransport;
        }

        if(showHandle) document.getElementById('handling').value = handling.toFixed(1);
        if(showTrans) document.getElementById('transport').value = transport.toFixed(1);

        updateTotalOnly();
    }

    function toggleField(divId, inputId, isVisible) {
        const div = document.getElementById(divId);
        const input = document.getElementById(inputId);
        if (isVisible) {
            div.style.opacity = '1';
            input.readOnly = false;
        } else {
            div.style.opacity = '0.3';
            input.value = 0;
            input.readOnly = true;
        }
    }

    function updateTotalOnly() {
        const handling = getVal('handling');
        const transport = getVal('transport');
        const railway = getVal('railway');
        const total = handling + transport + railway;
        document.getElementById('display_total').innerText = "₹ " + total.toLocaleString('en-IN');
    }

    // Run on load to set initial state
    window.onload = autoCalc;
</script>
{% endblock %}